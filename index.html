<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>VK API APP</title>
</head>
<body>
    <button id='load'>Show friends</button>
    <button id='token'>Try to get token</button>
    <ul></ul>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type='text/javascript'>
    $('#load').on('click', loadFriends);
    $('#token').on('click', getToken);

    function getUrl(method, params){
        if (!method){
            throw new Error('No method used');
        }
        params = params || {};
        params['access_token'] = '';
        return `https://api.vk.com/method/${method}?${$.param(params)}`
    }

    function sendRequest(method, params, func){
        $.ajax({
            url: getUrl(method, params),
            method: 'GET',
            dataType: 'JSONP',
            success: func,
        });
    }

    function loadFriends(){
        sendRequest('friends.search', {count: 5, fields: 'photo_100,online', v: '5.52'}, (data)=>{
            drawFriends(data.response.items);
        });
    }

    function drawFriends(friends){
        console.log(friends);
        let html = ''
        for (let i = 0; i < friends.length; ++i){
            let f = friends[i];
            html += `<li>
                        <a target="_blank" href="https://vk.com/id${f.id}">
                            <img src="${f.photo_100}" />
                            <div>
                                <h4>${f.first_name} ${f.last_name}</h4>
                            </div>
                        </a>
                    </li>`;
        }
        $('ul').html(html);
    }

    function getToken(){
        $.ajax({
            url: 'https://oauth.vk.com/authorize?client_id=7136546&display=popup&redirect_uri=https://stanislavmyakishev.github.io/test_vkapi/&scope=friends&response_type=token&v=5.101&state=123456',
            method: 'GET',
            dataType: 'JSON',
            xhrFields: {
                withCredentials: true
            },
            success: (data) => {
                console.log(data);
            },
        });
        let token = window.location.hash.toString();
        alert(token);
    }

    function getTokenUrl(){
        return `https://oauth.vk.com/authorize?client_id=7136546&display=popup&redirect_uri=https://stanislavmyakishev.github.io/test_vkapi/&scope=friends&response_type=token&v=5.101&state=123456`
    }

    function createCORSRequest(method, url) {
        var xhr = new XMLHttpRequest();
        if ("withCredentials" in xhr) {
          // Check if the XMLHttpRequest object has a "withCredentials" property.
          // "withCredentials" only exists on XMLHTTPRequest2 objects.
          xhr.open(method, url, true);
        } else if (typeof XDomainRequest != "undefined") {
          // Otherwise, check if XDomainRequest.
          // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
          xhr = new XDomainRequest();
          xhr.open(method, url);
        } else {
          // Otherwise, CORS is not supported by the browser.
          xhr = null;
        }
        return xhr;
      }
      
      var xhr = createCORSRequest('GET', 'https://oauth.vk.com/authorize?client_id=7136546&display=popup&redirect_uri=https://stanislavmyakishev.github.io/test_vkapi/&scope=friends&response_type=token&v=5.101&state=123456');
      if (!xhr) {
        throw new Error('CORS not supported');
      }
      console.log(xhr);
</script>
</html>