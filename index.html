<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>VK API APP</title>
</head>
<body>
    <button id='login'>Login</button>
    <button id='logout'>Logout</button>
    <p></p>
    <ul></ul>
    <div id="vk_api_transport"></div>
</body>
<script type="text/javascript">
    window.vkAsyncInit = function() {
      VK.init({
        apiId: 7136546,
      });
    };
    setTimeout(function() {
      var el = document.createElement("script");
      el.type = "text/javascript";
      el.src = "https://vk.com/js/api/openapi.js?162";
      el.async = true;
      document.getElementById("vk_api_transport").appendChild(el);
    }, 0);
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<script type='text/javascript'>

    if (Cookies.get('user_name')){
        $('p').html(writeHello(Cookies.get('user_name')))
    }

    if (localStorage.getItem('vk_friends_list') !== null){
        resp = JSON.parse(localStorage.getItem('vk_friends_list'))
        $('ul').html(drawAppearence(resp))
    }

    function drawAppearence(resp){
        let html = ''            
        let friends = {}
        if (resp !== null){
            if (resp.count !== 0){
                friends = resp.items
                for (let i = 0; i < friends.length; ++i){
                    let f = friends[i];
                    html += `<li>
                            <a target="_blank" href="https://vk.com/id${f.id}">
                                <img src="${f.photo_100}" />
                                <div>
                                    <h4>${f.first_name} ${f.last_name}</h4>
                                </div>
                            </a>
                        </li>`
                }
            } else {
                html += 'No added friends yet :(';
            }
            console.log(html+'drawAppearance')
            return html
        }
    }
    
    function callFriends(){
        let promise = new Promise((resolve) => {
            VK.Api.call('friends.search', {count: 5, fields: 'photo_100,online', v: '5.52'}, (resp) => {
                let html = ''
                html = drawAppearence(resp.response)
                console.log(html+'callFirends')
                localStorage.setItem('vk_friends_list', JSON.stringify(resp.response))
                resolve(html)
            })
        })
        promise
            .then(
                res => {
                    console.log(res)
                    return res
                }
            )
    }

    function writeHello(first_name){
        return `Привет, ${first_name}`
    }

    $('#login').click((event) =>{
        event.preventDefault()
        let friendsList
        let promise = new Promise((resolve) => {
            VK.Auth.login((resp) => {
                Cookies.set('user_name', `${resp.session.user.first_name}`)
                $('p').html(writeHello(resp.session.user.first_name))
                resolve(callFriends())
            }, VK.access.FRIENDS)
        })
        promise
            .then(
                res => {
                    console.log(res)
                    $('ul').html(res)       
                }
            )
    })

    $('#logout').click((event) =>{
        event.preventDefault()
        defaultLogoutResp = {}
        VK.Auth.logout((resp) => {
            localStorage.removeItem('vk_friends_list')
            Cookies.remove('user_name')
            console.log('everything is ok')
        })
        VK.Auth.revokeGrants((resp) => {
            console.log('you have loged out')  
        })
    })
</script>
</html>